<!doctype html>

<html lang="en">

<head>
    <meta charset="utf-8">

    <title>African Conflict 2018</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" />
    <link rel="stylesheet" href="libs/Leaflet.markercluster/MarkerCluster.Default.css"> />
    <link rel="stylesheet" href="libs/Leaflet.markercluster/MarkerCluster.css"> />
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            width: 100%;
            top: 0;
            bottom: 0;
        }

        #map-legend {
            position: absolute;
            top: 10px;
            right: 0;
            left: 2.5rem;
            z-index: 1000;
            margin: auto;
            display: inline-block;
            padding: 0 1.25rem;
            cursor: pointer;
        }

        #map-legend i {
            width: 14.28%;
            height: 2.25rem;
            float: left;
            opacity: 1;
            line-height: 2.25rem;
            font-size: 0.8rem;
            text-align: center;
            font-style: normal;
        }
    </style>
</head>

<body>

<div id="map"></div>
<div id="map-legend">

</div>

<script src="https://d3js.org/d3-fetch.v1.min.js"></script>
<script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"></script>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="libs/Leaflet.markercluster/leaflet.markercluster.js"></script>

<script>
    // map options
    var options = {
        center: [3.5832, 25.5085],
        zoom: 4,
    };
    // instantiate Leaflet map
    var map = L.map('map', options);

    // add CARTO voyager tiles with no labels
    L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/rastertiles/voyager_nolabels/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, &copy;<a href="https://carto.com/attribution">CARTO</a>'
    }).addTo(map);

    const countriesJson = d3.json('data/africa-countries-counts.json');
    const conflictsJson = d3.json('data/africa-conflict-2018.json');
    const colorsJson = d3.json('data/sunset-dark-colors.json');

    Promise.all([countriesJson, conflictsJson, colorsJson]).then(dataReady);

    function dataReady(data) {

        const countries = data[0];
        const conflicts = data[1];
        const colors = data[2];

        const legend = $('#map-legend');
        const legendBreaks = ['Undefined', '0 - 3', '3 - 9', '9 - 20', '20 - 60', '60 - 120', '120 - 410'];

        legendBreaks.forEach((brk, i) => {
            const color = i > 4 ? '#F1F1F1' : '#000';  // text color for legend, white for darker backgrounds
            const backgroundCol = brk === 'Undefined' ? '#FFF' : colors.SunsetDark[6][i - 1];
            legend.append(`<i style="background: ${ backgroundCol }; color: ${ color }"> ${ brk } </i>`);
        });

        var countriesLayer = L.geoJson(countries, {
            style: (feature) => {
                // style each polygon categorically with Vivid color palette
                return {
                    fillOpacity: 1,
                    color: '#FFF',
                    opacity: 0.5,
                    weight: 1,
                    fillColor: styleCountries(feature.properties.deaths_per_million, colors)
                }
            },
            onEachFeature: (feature, layer) => {
                // console.log(layer.feature.properties.NAME + ': ' + layer.feature.properties.deaths_per_million);
                // console.log(layer.options.fillColor);
                // console.log(feature);
            }
        }).addTo(map);

        var markers = L.markerClusterGroup();

        // loop through each signal
        conflicts.features.forEach((feature) => {
            // var coords = feature.geometry.coordinates,
                // marker = L.circleMarker([coords[1], coords[0]]);
                var marker = L.geoJson(feature, {
                    style: () => ({
                        fillColor: 'whitesmoke',
                        color: '#414140',
                        opacity: 1,
                        fillOpacity: 1,
                        weight: 1,
                        radius: feature.properties.incident_fatalities * 4,
                        // radius: 180,
                    }),
                    pointToLayer: (feature, latlng) => {
                        return L.circleMarker(latlng)
                            .bindTooltip(`Number of Fatalities: ${feature.properties.incident_fatalities}
                                          <br>Country: ${feature.properties.country}`);
                    }
                });

            // add each marker to markers cluster
            markers.addLayer(marker);
        });

        // add marker cluster layer to map
        map.addLayer(markers);

        $('#map-legend i').on('mouseover', function() {
            // console.log(this.style.background);

            countriesLayer.eachLayer(layer => {
                if (this.style.background === hexToRGB(layer.options.fillColor)) {

                    // console.log(hexToRGB(layer.options.fillColor));
                    console.log(layer.feature.properties.NAME);
                }
            })
        });
    }

    /**
     * Style countries based on number of fatalities per 1 million people
     * @param feature
     * @param colors
     * @returns {string}
     */
    function styleCountries(feature, colors) {
        return feature <= 0.01 ? '#FFF' :
            feature <= 3 ? colors.SunsetDark[6][0] :
                feature <= 9 ? colors.SunsetDark[6][1] :
                    feature <= 20 ? colors.SunsetDark[6][2] :
                        feature <= 60 ? colors.SunsetDark[6][3] :
                            feature <= 120 ? colors.SunsetDark[6][4] :
                                feature <= 410 ? colors.SunsetDark[6][5] :
                                    '#FFF';
    }

    function hexToRGB(hex) {
        let c;
        if (/^#([A-Fa-f0-9]{3}){1,2}$/.test(hex)) {
            c = hex.substring(1).split('');
            if (c.length === 3) {
                c = [c[0], c[0], c[1], c[1], c[2], c[2]];
            }
            c = '0x' + c.join('');
            return 'rgb(' + ((c >> 16) & 255) + ', ' + ((c>>8) & 255) + ', ' + (c&255) + ')';
        }
    }

</script>
</body>

</html>
