<!doctype html>

<html lang="en">

<head>
    <meta charset="utf-8">

    <title>African Conflict 2018</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" />
    <link rel="stylesheet" href="libs/Leaflet.markercluster/MarkerCluster.Default.css"> />
    <link rel="stylesheet" href="libs/Leaflet.markercluster/MarkerCluster.css"> />
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            width: 100%;
            top: 0;
            bottom: 0;
        }

        .legend {
            line-height: 18px;
            color: #555;
            z-index: 1000;
            background: #FFF;
            padding: 1rem;
        }

        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 1;
            z-index: 1000;
        }

        .legend-container {
            background: rgba(255, 255, 255, 1);
            /*width: 15rem;*/
            /*height: 15rem;*/
            border-radius: 4px;
            z-index: 500;
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            flex-direction: row;
        }

        #mapLegend {
            position: absolute;
            top: 10px;
            right: 0;
            left: 2.5rem;
            z-index: 1000;
            margin: auto;
            display: inline-block;
            padding: 0 1.25rem;
        }

        #mapLegend i {
            width: 14.28%;
            height: 2.25rem;
            float: left;
            opacity: 1;
            line-height: 2.25rem;
            font-size: 0.8rem;
            text-align: center;
            font-style: normal;
        }
    </style>
</head>

<body>

<div id="map"></div>
<div class="legend-container"></div>
<div id="mapLegend">
<!--    <i style="background: #e63c2e">< -25</i>-->
<!--    <i style="background: #f0857c">-24 to -10</i>-->
<!--    <i style="background: #f9cbc7">-10 to <0</i>-->
<!--    <i style="background: #ffffff">0</i>-->
<!--    <i style="background: #b8cfd2">>0 to +10</i>-->
<!--    <i style="background: #6b9a9f; color: whitesmoke;">+11 to +24</i>-->
<!--    <i style="background: #155F66; color: whitesmoke;">> +25</i>-->
<!--    <i style="background: #C6CBCB;">Undefined</i>-->
</div>

<script src="https://d3js.org/d3-fetch.v1.min.js"></script>
<script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"></script>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="libs/Leaflet.markercluster/leaflet.markercluster.js"></script>

<script>
    // map options
    var options = {
        center: [0.5832, 25.5085],
        zoom: 4
    };
    // instantiate Leaflet map
    var map = L.map('map', options);

    // add CARTO voyager tiles with no labels
    L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/rastertiles/voyager_nolabels/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, &copy;<a href="https://carto.com/attribution">CARTO</a>'
    }).addTo(map);

    const countriesJson = d3.json('data/africa-countries-counts.json');
    const conflictsJson = d3.json('data/africa-conflict-2018.json');
    const colorsJson = d3.json('data/sunset-dark-colors.json');

    Promise.all([countriesJson, conflictsJson, colorsJson]).then(dataReady);

    function dataReady(data) {

        const countries = data[0];
        const conflicts = data[1];
        const colors = data[2];

//         // store a reference to the HTML list
//         const legendList = $('#legend-list');
//
// // loop through the features and create a new
// // list item for each feature in the legend
//         for(let i = 1; i <= districts.features.length; i++) {
//             legendList.append('<li class="legend-item" id="district-' + i + '"><a style="color:' + colors.Vivid[10][i -1] + '" href="#">District ' + i + ' (<span></span>)</a></li>');
//         }

        const legend = $('#mapLegend');
        const legendBreaks = ['Undefined', '0 - 3', '3 - 9', '9 - 20', '20 - 60', '60 - 120', '120 - 410'];

        legendBreaks.forEach((brk, i) => {
            // console.log(brk, i);
            console.log(colors.SunsetDark[6][i]);
            if (brk === 'Undefined') {
                legend.append(`<i style="background: white"> ${brk}</i>`);

            } else {
                legend.append(`<i style="background: ${colors.SunsetDark[6][i - 1]}"> ${brk}</i>`);
            }
        });

        // // reference html id
        // const legendList = $('#legend-list');
        //
        // var breaks = [0.01, 3, 9, 20, 60, 120, 410];
        //
        // breaks.forEach(val => {
        //     // console.log(val);
        //     const col = styleCountries(val, colors);
        //     // console.log(col);
        // });
        //
        //
        // // loop through the features and create a new list item for each feature in the legend
        // for (let i = 1; i <= countries.features.length; i++) {
        //
        //
        //
        //
        //     countries.features.forEach(feat => {
        //         // console.log(feat.properties.deaths_per_million);
        //
        //         // legendList.append(`<li class="legend-item" id="${feat.properties.NAME}">
        //         //                 <a style="color: ${colors.SunsetDark[6][i -1]}" href="#">${feat.properties.NAME} (<span></span>)</a></li>`);
        //     });
        //
        // }


        // var legend = L.control({position: 'bottomright'});
        //
        // legend.onAdd = (map) => {
        //
        //     var div = L.DomUtil.create('div', 'info legend'),
        //         grades = [0.01, 3, 9, 20, 60, 120, 410];
        //
        //     // loop through our density intervals and generate a label with a colored square for each interval
        //     for (var i = 0; i < grades.length; i++) {
        //         // console.log(grades[i]);
        //         div.innerHTML +=
        //             '<i style="background:' + styleCountries(grades[i], colors) + '"></i> ' +
        //             grades[i - 1] + (grades[i] ? '&ndash;' + grades[i] + '<br>' : '+');
        //     }
        //
        //     return div;
        // };
        //
        // legend.addTo(map);
        // console.log(countries);

        var countriesLayer = L.geoJson(countries, {
            style: (feature) => {
                // style each polygon categorically with Vivid color palette
                return {
                    fillOpacity: 1,
                    color: '#FFF',
                    opacity: 0.5,
                    weight: 1,
                    fillColor: styleCountries(feature.properties.deaths_per_million, colors)
                }
            },
            onEachFeature: (feature, layer) => {
                // console.log(layer.feature.properties.NAME + ': ' + layer.feature.properties.deaths_per_million);
            }
        }).addTo(map);

        var markers = L.markerClusterGroup();

        // loop through each signal
        conflicts.features.forEach((feature) => {
            var coords = feature.geometry.coordinates,
                // marker = L.circleMarker([coords[1], coords[0]]);
                marker = L.geoJson(feature, {
                    style: () => ({
                        fillColor: 'whitesmoke',
                        opacity: 0.5,
                        fillOpacity: 1,
                        weight: 5,
                        radius: 5,
                    }),
                    pointToLayer: (feature, latlng) => {
                        return L.circleMarker(latlng)
                            .bindTooltip(`Number of Fatalities: ${feature.properties.incident_fatalities}
                                          <br>Country: ${feature.properties.country}`);
                    }
                });

            // add each marker to markers cluster
            markers.addLayer(marker);
        });

        // add marker cluster layer to map
        map.addLayer(markers);
    }

    /**
     * Style countries based on number of fatalities per 1 million people
     * @param feature
     * @param colors
     * @returns {string}
     */
    function styleCountries(feature, colors) {
        return feature <= 0.01 ? '#FFF' :
            feature <= 3 ? colors.SunsetDark[6][0] :
                feature <= 9 ? colors.SunsetDark[6][1] :
                    feature <= 20 ? colors.SunsetDark[6][2] :
                        feature <= 60 ? colors.SunsetDark[6][3] :
                            feature <= 120 ? colors.SunsetDark[6][4] :
                                feature <= 410 ? colors.SunsetDark[6][5] :
                                    '#FFF';

    }

    // d3.json('data/africa-countries-counts.json').then((data) => {
    //     const tmp = L.geoJson(data).addTo(map);
    //
    //     tmp.eachLayer((layer) => {
    //         console.log(layer.feature.properties.NAME + ': ' + layer.feature.properties.deaths_per_million);
    //     });
    // });

</script>
</body>

</html>
