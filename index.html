<!doctype html>

<html lang="en">

<head>
    <meta charset="utf-8">

    <title>African Conflict 2018</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" />
    <link rel="stylesheet" href="libs/Leaflet.markercluster/MarkerCluster.Default.css"> />
    <link rel="stylesheet" href="libs/Leaflet.markercluster/MarkerCluster.css"> />
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            width: 100%;
            top: 0;
            bottom: 0;
        }

        #map-legend {
            position: absolute;
            top: 10px;
            right: 0;
            left: 2.5rem;
            z-index: 1000;
            margin: auto;
            display: inline-block;
            padding: 0 1.25rem;
            cursor: pointer;
        }

        #map-legend i {
            width: 14.28%;
            height: 2.25rem;
            float: left;
            opacity: 1;
            line-height: 2.25rem;
            font-size: 0.8rem;
            text-align: center;
            font-style: normal;
        }

        .info-box {
            position: absolute;
            top: 3rem;
            right: 0.7rem;
            width: 15rem;
            z-index: 1000;
            padding: 0.75rem;
            border-radius: 4px;
            /*position: absolute;*/
            /*top: 2rem;*/
            /*right: 2rem;*/
            /*width: 10rem;*/
            /*height: 10rem;*/
            /*z-index: 1000;*/
            /*padding: 1rem;*/
        }

        .country-item {
            margin: 0.5rem 0;
        }

        span.country-name {
            /*font-size: 16px;*/
            font-weight: 500;
        }

        .country-info {
            font-size: 12px;
        }

        .info-title {
            font-size: 18px;
            font-weight: 500;
        }

    </style>
</head>

<body>

<div id="map"></div>
<div id="map-legend"></div>

<script src="https://d3js.org/d3-fetch.v1.min.js"></script>
<script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"></script>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="libs/Leaflet.markercluster/leaflet.markercluster.js"></script>

<script>
    // map options
    var options = {
        center: [3.5832, 25.5085],
        zoom: 4,
    };

    // instantiate Leaflet map
    var map = L.map('map', options);

    var infoBox = L.control();

    // add CARTO voyager tiles with no labels
    L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/rastertiles/voyager_nolabels/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, &copy;<a href="https://carto.com/attribution">CARTO</a>'
    }).addTo(map);

    // load country polygons, color styles, and conflict points
    const countriesJson = d3.json('data/africa-countries-counts.json');
    const conflictsJson = d3.json('data/africa-conflict-2018.json');
    const colorsJson = d3.json('data/sunset-dark-colors.json');

    Promise.all([countriesJson, conflictsJson, colorsJson]).then(dataReady);

    // after all jsons are loaded
    function dataReady(data) {

        const countries = data[0];
        const conflicts = data[1];
        const colors = data[2];

        // legend constants
        const legend = $('#map-legend');
        const legendBreaks = ['Undefined', '0 - 3', '3 - 9', '9 - 20', '20 - 60', '60 - 120', '120 - 410'];

        // build legend based on each legendBreak, style with respective SunsetDark colors
        legendBreaks.forEach((brk, i) => {
            const color = i > 4 ? '#F1F1F1' : '#000';  // text color for legend, white for darker backgrounds
            const backgroundCol = brk === 'Undefined' ? '#FFF' : colors.SunsetDark[6][i - 1];
            legend.append(`<i style="background: ${ backgroundCol }; color: ${ color }"> ${ brk } </i>`);
        });

        var countriesLayer = L.geoJson(countries, {
            style: (feature) => {
                return {
                    fillOpacity: 1,
                    color: '#FFF',
                    opacity: 0.5,
                    weight: 1,
                    fillColor: styleCountries(feature.properties.deaths_per_million, colors)
                }
            },
            onEachFeature: (feature, layer) => {
                layer.on('mouseover', (e) => {

                });
            }
        }).addTo(map);

        var markers = L.markerClusterGroup({spiderfyOnMaxZoom: false, disableClusteringAtZoom: 8});

        // loop through each signal
        conflicts.features.forEach((feature) => {
            // var coords = feature.geometry.coordinates,
                // marker = L.circleMarker([coords[1], coords[0]]);
                var marker = L.geoJson(feature, {
                    style: () => ({
                        fillColor: 'whitesmoke',
                        color: '#414140',
                        opacity: 1,
                        fillOpacity: 0.7,
                        weight: 1,
                        radius: feature.properties.incident_fatalities * 4,
                        // radius: 180,
                    }),
                    pointToLayer: (feature, latlng) => {
                        return L.circleMarker(latlng)
                            .bindTooltip(`Number of Fatalities: ${feature.properties.incident_fatalities}
                                          <br>Country: ${feature.properties.country}`);
                    }
                });

            // add each marker to markers cluster
            markers.addLayer(marker);
        });

        // add marker cluster layer to map
        map.addLayer(markers);

        $('#map-legend i')
            .on('mouseover', function() {
                const ctrys = [];
                const tmp = {};
                countriesLayer.eachLayer(layer => {
                    if (this.style.background === hexToRGB(layer.options.fillColor)) {
                        // ctrys.push(layer.feature.properties.NAME);
                        // TODO sort alphabetically
                        tmp[layer.feature.properties.NAME] = layer.feature.properties.deaths_per_million;
                        // console.log(tmp);

                        layer.setStyle({ fillOpacity: 1, opacity: 1 }).bringToFront();

                        // console.log(layer.feature.properties.NAME);

                        // TODO exclude undefined from reading in numbers of deaths
                        infoBox.onAdd = () => {
                            var div = L.DomUtil.create('div', 'info-box');  // create info-box div
                            div.style.background = this.style.background;
                            // console.log()
                            // "#c5287b","#7c1d6f"
                            const textColor = layer.options.fillColor === '#c5287b' || layer.options.fillColor === '#7c1d6f' ? '#FFF' : '#000';
                            div.innerHTML += `<div class="info-title" style="color: ${textColor}">Deaths Per Million Residents</div>`;
                            Object.entries(tmp).forEach(([ctry, deaths]) => {
                                console.log(ctry, deaths);
                                div.innerHTML += `<div class="country-item" style="color: ${textColor}"><span class="country-name">${ ctry }</span> (~${deaths.toFixed(0)} Deaths/Million) </div>`;
                                // div.innerHTML += `<div class="country-name">${ ctry }: ${ deaths.toFixed(0) } Deaths Per Million Residents </div>`;

                            });

                            // ctrys.sort().forEach(ctry => {
                            //     // TODO: Pull in deaths
                            //     div.innerHTML += `<div class="country-name">${ ctry }</div><div class="country-info"></div>`;
                            // });
                            // div.innerHTML += `<p> ${ ctrys.join('\n') } </p><br>`;
                        //     const target = e.target.feature.properties;
                        //     div.style.background = styleColor(target.type_generic);  // apply dynamic styles
                        //
                        //     // content
                        //     div.innerHTML = `<div class='center'> <h6>${ target.name }</h3></div>
                        // <hr> <b>${ target.name }</b> is a ${ target.type } establishment located in ${ target.city }
                        // (${ target.county } County), New York. </div></div>`;
                            return div;
                        }
                        infoBox.addTo(map);

                        // TODO: Try to filter marker cluster
                        markers.eachLayer(markerLayer => {
                            if (markerLayer.feature.properties.country === layer.feature.properties.NAME) {

                            }
                        });

                    } else {
                        layer.setStyle({ fillOpacity: 0.2, opacity: 0.2 }).bringToBack();
                    }
                });


            })
            .on('mouseout', function() {
                countriesLayer.setStyle({
                    fillOpacity: 1,
                    opacity: 0.5,
                    weight: 1,
                });

                // markers.bringToFront();
            });
    }

    /**
     * Style countries based on number of fatalities per 1 million people
     * @param feature
     * @param colors
     * @returns {string}
     */
    function styleCountries(feature, colors) {
        return feature <= 0.0001 ? '#FFF' :
            feature <= 3 ? colors.SunsetDark[6][0] :
                feature <= 9 ? colors.SunsetDark[6][1] :
                    feature <= 20 ? colors.SunsetDark[6][2] :
                        feature <= 60 ? colors.SunsetDark[6][3] :
                            feature <= 120 ? colors.SunsetDark[6][4] :
                                feature <= 410 ? colors.SunsetDark[6][5] :
                                    '#FFF';
    }

    function hexToRGB(hex) {
        let c;
        if (/^#([A-Fa-f0-9]{3}){1,2}$/.test(hex)) {
            c = hex.substring(1).split('');
            if (c.length === 3) {
                c = [c[0], c[0], c[1], c[1], c[2], c[2]];
            }
            c = '0x' + c.join('');
            return 'rgb(' + ((c >> 16) & 255) + ', ' + ((c>>8) & 255) + ', ' + (c&255) + ')';
        }
    }

</script>
</body>

</html>
